<!doctype html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>WillGive</title>
    <link rel="stylesheet" href="/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/css/customJqueryValidation.css">
    <link rel="stylesheet" href="/assets/css/simple-sidebar.css" >
    <link rel="stylesheet" href="/assets/css/simplePagination.css" >
</head>
<body>
    <%activeMenu = "SignUp"%>
    <%include ../layout/navbar.ejs%>
<div class="container sidebar-content" style="height:auto; min-height: 90%;">
    <div class="row row-offcanvas row-offcanvas-left">

        <!-- sidebar -->
        <div class="col-xs-6 col-sm-3 sidebar-offcanvas"   id="sidebar" role="navigation"  >
            <div data-spy="affix" data-offset-top="15" data-offset-bottom="30">
                <ul class="nav" style="color: #000000;" id="sidebar-nav">
                    <li class="sidebar-offcanvas" style="font-style: italic; font-size: 40px; padding-bottom: 10%" >
                        <img src="<%=user.imageIconUrl%>" height="80" width="80"/> &nbsp;
                        <strong> <%=user.firstName%></strong></li>
                    <li>
                        <a href="/users/account" style="color: #000000;">Edit Profile</a>
                    </li>
                    <li  >
                        <a href="/users/settings" style="color: #000000;">Settings</a>
                    </li>
                    <li>
                        <a href="/users/paymentMethod" style="color: #000000;">Payment Method</a>
                    </li>
                    <li>
                        <a href="/users/contribution" style="color: #000000;"><strong>My Contributions</strong></a>
                    </li>
                    <li>
                        <a href="/users/pledge" style="color: #000000;">My Pledges</a>
                    </li>
                    <li>
                        <a href="/users/collections" style="color: #000000;">My Favorites</a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- main area -->
        <div class="col-xs-12 col-sm-9" data-spy="scroll" style="padding-left: 5%" data-target="#sidebar-nav">
            <h2 class="sub-header">My Pledges</h2>
            <div id="page" ></div>

            <div id="resultsContainer" class="">

                <div class="table-responsive">
                    <table id="transactionHistoryTable" class="table table-striped">
                        <thead>
                        <tr>
                            <th>Confirmation #</th>
                            <th>Date/Time</th>
                            <th>Amount($)</th>
                            <th>Contribute To</th>
                            <th>Status</th>
                            <th>Approve</th>
                        </tr>
                        </thead>
                        <tbody id="transactionHistoryTableBody">


                        </tbody>
                    </table>
                </div>
            </div>
            <div id="botPage" style="float: left"></div>
            <div id="noresult" style="display: none" >
                <h3>Sorry, you have no pledges yet</h3>
            </div>

        </div><!-- /.col-xs-12 main -->

    </div><!--/.row-->
</div><!--/.container-->



<%include ../layout/footer.ejs%>
<script src="/jquery/dist/jquery.min.js"></script>
<script src="/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/jquery-validation/dist/jquery.validate.js"></script>
<script src="/assets/js/jquery.simplePagination.js"></script>
<script>
    var transactionHistory=[];


    function approvePledge(pb) {

        var queryPledgeByConfirmationCode = '/payment/stripePayment/queryPledge/';

        alert("confirmationId: "+pb.id);//

        $.get(queryPledgeByConfirmationCode, { confirmationCode: pb.id}, function (result) {
            console.dir("queryPledgeByConfirmationCode: "+ pb.id);
            if (!result || result == "failed") {
                console.dir("failed to get results");
                //update transaction histroy and mark status as complete
                refreshPage();
                return;
            }
            //alert("currentResults:"+ result);
            stripeCustomerId = result.stripeCustomerId;
            amount =result.amount;
            receipientId =result.receipientId;

            jQuery("#amount").val(amount);
            jQuery("#stripeCustomerId").val(stripeCustomerId);
            jQuery("#receipientId").val(receipientId);
            jQuery("#isPledge").val(true);
            jQuery("#confirmationCode").val(pb.id);

            console.dir("stripeCustomerId(charity.ejs): " + stripeCustomerId);

            console.dir(" isPledge .val " +  jQuery("#isPledge").val());

            //if stripCustomerId not null, then post to the payment page automatically
            if ($.trim(stripeCustomerId)) {
                jQuery("#stripeCustomerId").val(stripeCustomerId);

                $('form').submit();

                console.dir("payment successfully made ");
                refreshPage();


                return;
            }

            refreshPage();
        });
    }

    var defaultHTML =
        '<tr> <td> {Id} </td> '+
        ' <td> {Date} </td> ' +
        ' <td class="text-center"> {Amount} </td> ' +
        ' <td> {Recipient} </td> ' +
        ' <td> {Status} </td> ' +
        ' <td> <button type="button" id={ConfirmationId} class=\'donateButton\' onclick=\'approvePledge(this);\'>Approve</button></td>'
        ' </tr> ';

    function replaceHtml(transaction){
        return defaultHTML.replace("{Id}",transaction.confirmationCode)
                .replace("{Date}",dateTimeDisplayFormatter(transaction.dateTime))
                .replace("{Amount}",transaction.amount)
                .replace("{Recipient}",'<a href="/charity/'+transaction.recipientId+'" style="color: #202090">'+transaction.name+'</a>')
                .replace("{Status}",transaction.status).replace("{ConfirmationId}",transaction.confirmationCode)
                ;

    }
        // function initResultPage(searchResults){
    function initResultPage(data){
        $('#botPage').empty();

        var itemsOnPage = 20;
        var resultConainer = $('#transactionHistoryTableBody');

        $('#botPage').pagination({  
            items: transactionHistory.length,
            itemsOnPage: itemsOnPage,
            onInit: initPage,
            currentPage: 0,
            onPageClick: function(){
                var page_index = $("#botPage").pagination('getCurrentPage') -1;
                resultConainer.empty();
                for(var i=page_index*itemsOnPage;i<(page_index+1)*itemsOnPage;++i) {
                    resultConainer.append(replaceHtml(transactionHistory[i]));
                }
                //$("#page").pagination('drawPage',$("#botPage").pagination('getCurrentPage'));

            },
            cssStyle: 'light-theme'
        });



        function initPage() {
            resultConainer.empty();
            for(var i=0;i<itemsOnPage && i< transactionHistory.length;++i) {
                resultConainer.append(replaceHtml(transactionHistory[i]));
            }
        }
    }



</script>

    <form id="form" action="/payment/stripePayment" method="POST" style="display:none;">
        <input id="amount"  name="amount" value="0">
        <input id="notes"  name="notes" value="0">
        <input id="receipientId"  name="receipientId" value="0">
        <input id="stripeCustomerId"  name="stripeCustomerId" value="0">
        <input id= stripeTokenInput type=hidden name=stripeToken />
        <input id= confirmationCode type=hidden name=confirmationCode />
        <input id="isPledge"  name="isPledge" value=false>

    </form>




<script>

    function refreshPage(){
        location.reload();
    }

    function displayNoResults(){
        //resultConainer.empty();
        $('#botPage').empty();
        $('#noresult').show(); //text("Sorry, you have no contribution yet.");//add keyword

    }
    function dateDisplayFormatter( cellvalue, options, rowObject ){
        return cellvalue.substr(0,10);
    }
    function dateTimeDisplayFormatter( cellvalue, options, rowObject ){
        return cellvalue.substr(0,16);
    }
    function getUserTransactionHistory(){
       $.get('/services/user/getPledgeHistory',function(data){
           if(!data || data == "failed") {
               //get history failed
               return;
           }
           if(data.length>0) {
               console.dir(data);
               transactionHistory = data;
               initResultPage(data);
           }
           else {
               displayNoResults();
           }
       })
    }

   $( document).ready(function(){
       getUserTransactionHistory();
   })
</script>
</body>
</html>